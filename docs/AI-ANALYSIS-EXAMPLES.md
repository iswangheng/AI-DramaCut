# AI 分析结果示例文档

本文档展示 Gemini 2.5 Pro 返回的分析结果，以及这些数据如何用于**高光切片**和**深度解说**功能。

---

## 📊 完整的分析流程

```
视频上传 → 元数据提取 → 自动触发 4 个 AI 任务：
  1. extract-shots: FFmpeg 镜头检测（场景切换点）
  2. analyze: Gemini 视频+音频分析（语义理解）
  3. extract-storylines: 故事线提取（独立剧情线）
  4. detect-highlights: 高光时刻检测（病毒式传播点）
```

---

## 🎬 示例视频：霸道总裁短剧《身份曝光》第 1 集

**视频信息**：
- 文件名：`霸道总裁爱上我.S01E01.身份曝光.mp4`
- 时长：45 分 32 秒（2732000 毫秒）
- 分辨率：1080x1920（竖屏）
- 帧率：30 fps
- 文件大小：1.2 GB

---

## 1️⃣ Gemini 返回的原始分析数据

### `VideoAnalysis` 对象

```json
{
  "summary": "豪门千金林浅遭遇车祸失忆，被误认为是普通员工。霸道总裁顾夜琛在收购谈判中与林浅发生冲突，后在相处中逐渐被她的坚韧和善良吸引，却发现她就是自己童年暗恋的女孩。",

  "viralScore": 8.5,

  "scenes": [
    {
      "startMs": 0,
      "endMs": 5000,
      "description": "开场镜头：豪华别墅大门，雨夜，一辆黑色跑车疾驰而来，突然刹车声，画面黑场",
      "emotion": "悬疑",
      "dialogue": "旁白：那个雨夜，改变了一切。",
      "characters": ["旁白"],
      "viralScore": 6.0,
      "audioInfo": {
        "hasDialogue": true,
        "dialogue": "旁白：那个雨夜，改变了一切。",
        "bgmStyle": "悬疑紧张",
        "soundEffects": ["刹车声", "雷声", "雨声"]
      }
    },
    {
      "startMs": 15000,
      "endMs": 45000,
      "description": "林浅身穿白色礼服从宴会厅跑出，表情惊恐，身后有保镖追赶。她慌不择路冲入雨中，一辆轿车疾驰而来，林浅被撞飞，画面慢镜头特写她的脸。",
      "emotion": "惊恐",
      "dialogue": "林浅：不要追我！\n保镖：大小姐，您不能走！",
      "characters": ["林浅", "保镖"],
      "viralScore": 9.2,
      "audioInfo": {
        "hasDialogue": true,
        "dialogue": "林浅：不要追我！\n保镖：大小姐，您不能走！",
        "bgmStyle": "紧张急促",
        "soundEffects": ["高跟鞋奔跑声", "汽车刹车声", "撞击声", "玻璃破碎声"]
      }
    },
    {
      "startMs": 123000,
      "endMs": 128000,
      "description": "高光时刻：顾夜琛在会议室与林浅对峙，林浅不卑不亢反驳他的观点，顾夜琛眼神从轻蔑转为惊讶，最后嘴角上扬露出欣赏的笑容。",
      "emotion": "冲突+欣赏",
      "dialogue": "顾夜琛：你这种底层员工，懂什么叫商业谈判？\n林浅：顾总，商业谈判不是靠声音大，而是靠实力说话。您的收购方案漏洞百出，真的以为没人敢说真话吗？\n顾夜琛：......（沉默3秒）有点意思。",
      "characters": ["顾夜琛", "林浅"],
      "viralScore": 9.8,
      "audioInfo": {
        "hasDialogue": true,
        "dialogue": "顾夜琛：你这种底层员工，懂什么叫商业谈判？\n林浅：商业谈判不是靠声音大，而是靠实力说话。您的收购方案漏洞百出，真的以为没人敢说真话吗？\n顾夜琛：......有点意思。",
        "bgmStyle": "紧张后转为轻松",
        "soundEffects": ["文件摔桌声", "沉默3秒", "轻笑声"]
      }
    },
    {
      "startMs": 2345000,
      "endMs": 2352000,
      "description": "大反转：顾夜琛的手机收到一张照片，是童年时和小女孩的合影，那个小女孩就是林浅。顾夜琛瞳孔放大，手机掉落在地，镜头特写他震惊的表情。",
      "emotion": "震惊",
      "dialogue": "顾夜琛：不可能...怎么会是她...",
      "characters": ["顾夜琛"],
      "viralScore": 10.0,
      "audioInfo": {
        "hasDialogue": true,
        "dialogue": "顾夜琛：不可能...怎么会是她...",
        "bgmStyle": "悬疑+震撼",
        "soundEffects": ["手机掉落声", "心跳声特效"]
      }
    }
  ],

  "storylines": [
    {
      "name": "身份之谜",
      "description": "林浅的真实身份是豪门千金，但因为失忆被误认为是普通员工。顾夜琛逐渐发现线索，最终确认她的身份。",
      "category": "identity",
      "attractionScore": 9.5,
      "shotIds": [1, 2, 5, 12, 18, 23, 45, 67]
    },
    {
      "name": "霸道总裁的傲娇",
      "description": "顾夜琛从最初看不起林浅，到被她的才华和坚韧吸引，感情逐渐升温。每次互动都有火花。",
      "category": "romance",
      "attractionScore": 8.8,
      "shotIds": [3, 6, 8, 15, 20, 28, 35, 50, 65]
    },
    {
      "name": "商业帝国斗争",
      "description": "顾夜琛的收购案背后隐藏着商业阴谋，林浅无意中卷入其中，成为关键棋子。",
      "category": "power",
      "attractionScore": 7.5,
      "shotIds": [7, 9, 11, 16, 25, 30, 40, 55]
    },
    {
      "name": "恶毒女配的陷害",
      "description": "顾夜琛的未婚妻苏晴发现林浅的存在，多次设计陷害，但每次都被林浅机智化解。",
      "category": "revenge",
      "attractionScore": 8.2,
      "shotIds": [4, 10, 13, 19, 27, 33, 42, 58]
    }
  ],

  "highlights": [
    {
      "timestampMs": 125000,
      "type": "conflict",
      "confidence": 0.95,
      "description": "林浅当众反驳顾夜琛的商业方案，震撼全场",
      "suggestedStartMs": 123000,
      "suggestedEndMs": 128000,
      "viralScore": 9.8,
      "category": "conflict",
      "suggestedDuration": 5
    },
    {
      "timestampMs": 2347000,
      "type": "reveal",
      "confidence": 0.98,
      "description": "顾夜琛发现林浅就是童年暗恋的女孩，震惊表情特写",
      "suggestedStartMs": 2345000,
      "suggestedEndMs": 2352000,
      "viralScore": 10.0,
      "category": "reversal",
      "suggestedDuration": 7
    },
    {
      "timestampMs": 1890000,
      "type": "emotional",
      "confidence": 0.92,
      "description": "林浅回忆起童年片段，眼眶含泪的特写镜头",
      "suggestedStartMs": 1885000,
      "suggestedEndMs": 1895000,
      "viralScore": 9.0,
      "category": "emotional",
      "suggestedDuration": 10
    },
    {
      "timestampMs": 456000,
      "type": "climax",
      "confidence": 0.89,
      "description": "恶毒女配苏晴故意将红酒泼在林浅身上，全场哗然",
      "suggestedStartMs": 454000,
      "suggestedEndMs": 459000,
      "viralScore": 8.7,
      "category": "conflict",
      "suggestedDuration": 5
    }
  ],

  "durationMs": 2732000
}
```

---

## 2️⃣ 保存到数据库后的实际数据

### 📦 `shots` 表（镜头切片）

| id | video_id | start_ms | end_ms | description | emotion | dialogue | viral_score |
|----|----------|----------|---------|-------------|---------|----------|-------------|
| 1 | 1 | 0 | 5000 | 开场镜头：豪华别墅大门，雨夜，一辆黑色跑车疾驰而来...<br>【音频信息】对白: "旁白：那个雨夜，改变了一切。" \| 配乐: 悬疑紧张 \| 音效: 刹车声, 雷声, 雨声 | 悬疑 | 旁白：那个雨夜，改变了一切。 | 6.0 |
| 2 | 1 | 15000 | 45000 | 林浅身穿白色礼服从宴会厅跑出...<br>【音频信息】对白: "林浅：不要追我！..." \| 配乐: 紧张急促 \| 音效: 高跟鞋奔跑声, 撞击声 | 惊恐 | 林浅：不要追我！<br>保镖：大小姐，您不能走！ | 9.2 |
| 3 | 1 | 123000 | 128000 | **高光时刻**：顾夜琛在会议室与林浅对峙...<br>【音频信息】对白: "顾夜琛：你这种底层员工..." \| 配乐: 紧张后转为轻松 | 冲突+欣赏 | 顾夜琛：你这种底层员工...<br>林浅：商业谈判不是靠声音大... | **9.8** |
| 4 | 1 | 2345000 | 2352000 | **大反转**：顾夜琛的手机收到一张照片...<br>【音频信息】对白: "顾夜琛：不可能..." \| 配乐: 悬疑+震撼 \| 音效: 手机掉落声, 心跳声特效 | 震惊 | 顾夜琛：不可能...怎么会是她... | **10.0** |

**关键用途**：
- ✅ **高光切片模式**：根据 `viralScore` 排序，找到爆款片段
- ✅ **深度解说模式**：根据 `description` 和 `dialogue` 进行语义搜索，匹配解说词
- ✅ **时间精确定位**：`start_ms` 和 `end_ms` 支持毫秒级 FFmpeg 切割

---

### 📦 `storylines` 表（故事线）

| id | video_id | name | category | attraction_score | shot_ids |
|----|----------|------|----------|------------------|----------|
| 1 | 1 | 身份之谜 | identity | **9.5** | [1,2,5,12,18,23,45,67] |
| 2 | 1 | 霸道总裁的傲娇 | romance | **8.8** | [3,6,8,15,20,28,35,50,65] |
| 3 | 1 | 商业帝国斗争 | power | 7.5 | [7,9,11,16,25,30,40,55] |
| 4 | 1 | 恶毒女配的陷害 | revenge | 8.2 | [4,10,13,19,27,33,42,58] |

**关键用途**：
- ✅ **深度解说模式**：选择一条故事线，自动生成解说文案
- ✅ **画面匹配**：根据 `shot_ids` 找到相关镜头，拼接成解说视频
- ✅ **多版本生成**：同一条故事线可以生成多种解说风格（悬念、吐槽、情绪）

---

### 📦 `highlights` 表（高光候选）

| id | video_id | start_ms | end_ms | duration_ms | reason | viral_score | category |
|----|----------|----------|---------|-------------|---------|-------------|----------|
| 1 | 1 | 123000 | 128000 | 5000 | Gemini 自动检测 | **9.8** | conflict |
| 2 | 1 | 2345000 | 2352000 | 7000 | Gemini 自动检测 | **10.0** | reversal |
| 3 | 1 | 1885000 | 1895000 | 10000 | Gemini 自动检测 | 9.0 | emotional |
| 4 | 1 | 454000 | 459000 | 5000 | Gemini 自动检测 | 8.7 | conflict |

**关键用途**：
- ✅ **高光切片模式**：展示高光列表，用户预览后确认/调整
- ✅ **毫秒级微调**：用户可以修改 `start_ms` 和 `end_ms`（±100ms/±500ms/±1000ms）
- ✅ **一键导出**：根据时间戳使用 FFmpeg 精确切割

---

## 3️⃣ 这些数据如何用于实际功能？

### 🔥 模式 A：高光智能切片

**用户操作流程**：
1. 进入"高光切片模式"页面
2. 看到高光列表（按 `viral_score` 排序）：
   ```
   🥇 身份曝光大反转 (10.0分) - 00:39:05.000 ~ 00:39:12.000
   🥈 会议室霸气反驳 (9.8分) - 00:02:03.000 ~ 00:02:08.000
   🥉 回忆童年片段 (9.0分) - 00:31:25.000 ~ 00:31:35.000
   ```
3. 点击预览按钮，查看片段内容
4. 使用毫秒级微调：
   - 点击 `+100ms` 按钮，`start_ms` 从 123000 变为 123100
   - 点击 `-500ms` 按钮，`end_ms` 从 128000 变为 127500
5. 点击"导出切片"，后端执行：
   ```bash
   ffmpeg -ss 00:02:03.100 -i input.mp4 -t 00:00:04.400 \
          -c:v libx264 -preset fast -crf 18 output.mp4
   ```
6. 下载 60-90 秒的高光切片视频

**数据流**：
```
highlights 表 → 前端高光列表 → 用户微调 → FFmpeg 切割 → 导出视频
```

---

### 🎙️ 模式 B：深度解说矩阵

**用户操作流程**：
1. 进入"深度解说模式"页面
2. 选择一条故事线（例如"身份之谜"，9.5分）
3. 选择解说风格（例如"悬念钩子版"）
4. AI 自动生成解说文案：
   ```
   【黄金3秒】
   "她失忆了，却不知道自己是豪门千金！"

   【解说正文】
   "雨夜一场车祸，让林浅失去了所有记忆。
   醒来后，她发现自己成了一个普通员工，
   却不知道，自己正是豪门失散多年的千金..."

   【画面匹配】
   - 0s-5s: 镜头1（车祸场景）- shot_id: 2
   - 5s-10s: 镜头3（医院醒来）- shot_id: 5
   - 10s-15s: 镜头8（顾夜琛出现）- shot_id: 12
   ```
5. AI 自动匹配画面（基于语义搜索）：
   - 解说词"车祸场景" → 在 shots 表搜索 `description LIKE '%车祸%'`
   - 找到 shot_id: 2 (start_ms: 15000, end_ms: 45000)
6. TTS 生成语音（ElevenLabs），获取毫秒级词语时间戳
7. 四轨道混音：
   ```
   轨道1: 解说语音（音量 1.0）
   轨道2: 原始配音（音量 0.15）
   轨道3: 情绪 BGM（音量 0.3）
   轨道4: 音效（耳光、哭声等，保留）
   ```
8. Remotion 渲染最终视频

**数据流**：
```
storylines 表 → 选择故事线 → AI 生成文案
     ↓
shots 表 → 语义搜索匹配镜头 → 拼接多个镜头
     ↓
ElevenLabs TTS → 语音 + 时间戳 → 四轨道混音
     ↓
Remotion 渲染 → 最终解说视频（60-120秒）
```

---

## 4️⃣ 音频分析的特殊作用

音频信息（对白、配乐、音效）被嵌入到 `shots.description` 中：

```typescript
description: "林浅身穿白色礼服从宴会厅跑出...
【音频信息】对白: \"林浅：不要追我！...\" | 配乐: 紧张急促 | 音效: 高跟鞋奔跑声, 撞击声"
```

**用途**：
1. **深度解说模式**：搜索对白关键词，精准定位镜头
   ```
   搜索"商业谈判" → 找到 shot_id: 3（会议室对峙场景）
   ```
2. **情绪匹配**：根据 `bgmStyle` 选择合适的 BGM
3. **音效保留**：混音时保留关键音效（耳光、哭声等）

---

## 5️⃣ 完整的数据库查询示例

### 查询高光切片（模式 A）

```sql
-- 获取爆款分数 > 8.5 的高光时刻
SELECT * FROM highlights
WHERE viral_score > 8.5
ORDER BY viral_score DESC;

-- 结果：4 个高光候选（可以直接用于 UI 展示）
```

### 查询故事线（模式 B）

```sql
-- 获取吸引力分数 > 8.0 的故事线
SELECT * FROM storylines
WHERE attraction_score > 8.0
ORDER BY attraction_score DESC;

-- 结果：3 条故事线（身份之谜 9.5、霸道总裁的傲娇 8.8、恶毒女配的陷害 8.2）
```

### 语义搜索镜头（模式 B）

```sql
-- 搜索包含"车祸"的镜头
SELECT * FROM shots
WHERE description LIKE '%车祸%';

-- 结果：shot_id: 2（15000ms - 45000ms）
```

---

## 🎯 总结

AI 分析的核心价值：

1. **自动化**：上传视频后，AI 自动完成所有分析，无需人工标注
2. **结构化**：所有数据存入数据库，支持快速查询和排序
3. **毫秒级精度**：所有时间戳精确到毫秒，支持精确切割
4. **多模态**：同时分析画面和音频，信息更完整
5. **可扩展**：基于这些数据，可以开发更多功能（推荐、搜索、混剪等）

**下一步开发**：
- ✅ 后端 AI 分析：100% 完成
- 🚧 前端 UI：待开发（高光列表、预览播放器、毫秒级微调）
- 🚧 导出功能：待开发（FFmpeg 切割 + 进度显示）

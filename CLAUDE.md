# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 提供在此代码仓库中工作的指导。

## 重要：交流语言

**必须使用中文与用户对话和回应。** 所有解释、说明、讨论都应使用中文。代码注释和文档也应使用中文编写，除非技术术语本身为英文。

---

## 项目概述

DramaGen AI 是一款面向短剧/漫剧剪辑师、投放运营及自媒体博主的智能化视频生产工具。系统深度集成 Gemini 3 的多模态理解能力，实现从原始长视频到高点击短视频的自动化/半自动化产出。

**当前状态**: 项目处于**规划/文档阶段**，尚未编写任何源代码。

---

## 核心架构（规划中）

### 技术栈
- **前端**: Next.js 15 (App Router)、Tailwind CSS、Framer Motion
- **后端**: Next.js API Routes (Edge Runtime)、Node.js 视频处理
- **视频处理**: FFmpeg、Remotion 渲染引擎
- **AI 服务**: Gemini 3（视频分析）、ElevenLabs（TTS 语音生成）
- **数据存储**: SQLite + Drizzle ORM
- **任务队列**: BullMQ 处理重型任务
- **实时通信**: WebSocket 进度更新

### 两种核心操作模式

#### 模式 A：高光智能切片 (Highlight Hook)
自动识别并提取视频中的病毒传播时刻，支持毫秒级精度调整。

**核心需求**:
- AI 检测病毒式传播桥段（反转、身份曝光、冲突爆发）
- 从检测到的时间戳自动提取 60-120s 片段
- **毫秒级手动微调**: UI 必须提供 `±100ms`、`±500ms`、`±1000ms` 精度控制
- 切点实时预览
- 重编码 FFmpeg 工作流（非 copy 模式）实现帧级精确切割

#### 模式 B：深度解说矩阵 (Recap Matrix)
从故事线生成多版本解说文案，自动实现音画匹配。

**核心需求**:
- 从原始素材提取 ≥10 条独立故事线
- 生成多种解说风格（悬念钩子版、吐槽版、情绪共鸣版等）
- TTS 合成并获取毫秒级词语时间轴
- 语义搜索匹配解说词与相关视频片段
- 四轨道音频混音：解说(1.0) + 原音(0.15) + BGM(0.3)

---

## 关键技术约束

### 毫秒级精度（核心要求）
- 所有时间轴操作必须使用**毫秒**作为单位
- **FFmpeg 策略**: 禁止使用 `-vcodec copy`（只能跳转到 I 帧，不精确）
- **必需命令**: `ffmpeg -ss [HH:MM:SS.ms] -i input.mp4 -t [duration] -c:v libx264 -preset fast -crf 18 output.mp4`
- **帧率对齐**: 预处理时将所有素材统一为 30fps，确保毫秒计算与帧号完全匹配
- **验收标准**: 音画同步误差 < 50ms，切点无画面撕裂

### 视频处理管线
- **采样策略**: 关键帧采样 + 低分辨率代理，降低 Gemini Token 消耗
- **镜头检测**: 预处理长视频检测场景切换，为每段生成语义标签
- **向量检索**: 将镜头标签存储为向量，使用余弦相似度匹配解说词与相关片段
- **性能目标**: M1/M2/M3 芯片上，90s 视频渲染时间 ≤ 2x 实时（≤3 分钟）

### 任务队列架构
- 使用 **BullMQ** 管理重型 FFmpeg 和 Gemini 处理任务
- 集成 **WebSocket** 实现实时进度更新到 UI
- 并发调用 Gemini API 加速预处理
- 防止长渲染期间 Node.js 进程阻塞

---

## Remotion 组件规范

### ViralSubtitle 组件
- **样式**: 亮黄色加粗文字带黑边（抖音爆款风格）
- **动画**: Spring 弹簧动画实现"逐字跳动"或"上浮"效果，与语音节奏同步
- 必须支持从 ElevenLabs TTS 输出获取词语级时间数据

### 音轨混音
```
轨道 1: ElevenLabs 解说配音（音量: 1.0）
轨道 2: 原始环境音（音量: 0.15）
轨道 3: 情绪 BGM（音量: 0.3）
```

---

## UI/UX 设计标准

- **主题**: 极简浅色主题，背景 `#F8FAFC` (Slate-50)，白色组件卡片
- **导航**: 三标签布局 - `高光切片模式` | `深度解说模式` | `任务管理`
- **控件**: 专用毫秒级调整按钮，支持键盘快捷键
- **预览**: 调整切点时立即同步视频播放器

---

## API 集成要点

### Gemini 3（视频分析）
- 必须处理来自 `yunwu.ai` 代理的流式响应
- 实现超时处理和自动重连
- 使用"关键帧采样 + 低分辨率代理"策略降低 Token 成本

### ElevenLabs（TTS）
- 提取毫秒级词语时间数据用于字幕同步
- 将生成的音频和时间元数据存储到 SQLite

---

## 开发命令

*注意：目前尚未存在 package.json。实现开始后：*

```bash
# 预期开发命令（待实现）
npm run dev          # 启动 Next.js 开发服务器
npm run build        # 构建生产版本
npm run lint         # 运行 ESLint
npm run test         # 运行测试（添加测试套件后）
```

---

## 关键文档文件

- `config.md` - 核心配置和功能需求
- `DramaGen AI 产品需求文档 (PRD).md` - 完整产品需求和验收标准
- `DramaGen AI 技术架构方案.md` - 详细技术架构
- `DramaGen AI UI 设计与交互规范.md` - UI/UX 规范
- `技术方案：毫秒级精度与并发处理.md` - 毫秒级精度和并发处理实现细节
- `prompts.md` - Gemini 3 视频 AI 提示词

---

## 实现优先级

1. **基础搭建**: Next.js 15、SQLite schema、FFmpeg 封装工具
2. **模式 A**: 实现高光检测和毫秒级调整 UI
3. **处理管线**: 构建镜头检测和语义标签系统
4. **模式 B**: 开发解说生成和语义匹配
5. **渲染**: 实现 Remotion 组件和病毒式字幕动画
6. **性能优化**: 集成 BullMQ 任务队列管理
